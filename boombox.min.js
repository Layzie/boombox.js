"use strict";var _get=function a(b,c,d){var e=Object.getOwnPropertyDescriptor(b,c);if(void 0===e){var f=Object.getPrototypeOf(b);return null===f?void 0:a(f,c,d)}if("value"in e)return e.value;var g=e.get;return void 0===g?void 0:g.call(d)},_inherits=function(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(a.__proto__=b)},_classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},_createClass=function(){function a(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();/**
 * Browser sound library which blended HTMLVideo and HTMLAudio and WebAudio
 *
 * The MIT License (MIT)
 *
 * Copyright (c) 2014 CyberAgent, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 *
 * @license MIT
 * @author Kei Funagayama <funagayama_kei@cyberagent.co.jp>
 */
!function(a){var b=function(){},c=!("function"!=typeof define||!define.amd),d="-",e="-",f=function(a){return{prefix:a.substring(0,a.indexOf(d)),suffix:a.substring(a.indexOf(d)+1),name:a}},g=3,h=Array.prototype.slice,i=function(){function b(a){_classCallCheck(this,b),this.prefix=a||e,this.prefix="["+this.prefix+"]"}return _createClass(b,[{key:"trace",value:function(){1>=g&&a.console&&(a.console.trace?a.console.trace("[TRACE]",this.prefix,h.call(arguments).join(" ")):a.console.debug?a.console.debug("[TRACE]",this.prefix,h.call(arguments).join(" ")):a.console.log("[TRACE]",this.prefix,h.call(arguments).join(" ")))}},{key:"debug",value:function(){2>=g&&a.console&&(a.console.debug?a.console.debug("[DEBUG]",this.prefix,h.call(arguments).join(" ")):a.console.log("[DEBUG]",this.prefix,h.call(arguments).join(" ")))}},{key:"info",value:function(){3>=g&&a.console&&a.console.info("[INFO]",this.prefix,h.call(arguments).join(" "))}},{key:"warn",value:function(){4>=g&&a.console&&a.console.warn("[WARN]",this.prefix,h.call(arguments).join(" "))}},{key:"error",value:function(){5>=g&&a.console&&a.console.error("[ERROR]",this.prefix,h.call(arguments).join(" "))}}]),b}(),j=function(){function b(){_classCallCheck(this,b),this.VERSION="1.0.8",this.LOOP_NOT=0,this.LOOP_ORIGINAL=1,this.LOOP_NATIVE=2,this.POWER_OFF=!1,this.POWER_ON=!0,this.ERROR_MEDIA_TYPE=0,this.ERROR_HIT_FILTER=1,this.THRESHOLD=.2,this.setuped=!1,this.AudioContext=a.AudioContext||a.webkitAudioContext,this.support={mimes:[],webaudio:{use:!!this.AudioContext},htmlaudio:{use:!1},htmlvideo:{use:!1}},this.support.webaudio.use&&(this.WEB_AUDIO_CONTEXT=new this.AudioContext,this.WEB_AUDIO_CONTEXT.createGain||(this.WEB_AUDIO_CONTEXT.createGain=this.WEB_AUDIO_CONTEXT.createGainNode));try{this._audio=new a.Audio,this._audio.canPlayType?this.support.htmlaudio.use=!0:this.support.htmlaudio.use=!1}catch(c){this.support.htmlaudio.use=!1}try{this._video=document.createElement("video"),this._video.canPlayType?this.support.htmlvideo.use=!0:this.support.htmlvideo.use=!1}catch(c){this.support.htmlvideo.use=!1}this.pool={},this.waits=[],this.visibility={hidden:void 0,visibilityChange:void 0},this.state={power:this.POWER_ON},this.filter={}}return _createClass(b,[{key:"isWebAudio",value:function(){return this.support.webaudio.use}},{key:"isHTMLAudio",value:function(){return this.support.htmlaudio.use}},{key:"isHTMLVideo",value:function(){return this.support.htmlvideo.use}},{key:"isPlayback",value:function(){var a=!1;for(var b in this.pool)if(this.pool[b].isPlayback()){a=!0;break}return a}},{key:"setup",value:function(a){return a=a||{},"undefined"!=typeof a.threshold&&(this.THRESHOLD=a.threshold),"undefined"!=typeof a.loglevel&&(g=a.loglevel),this.logger=new i("Boombox "),this.setuped?(this.logger.warn('"setup" already, are running.'),this):(a.webaudio&&"undefined"!=typeof a.webaudio.use&&(this.support.webaudio.use=a.webaudio.use,this.logger.info("options.webaudio.use:",this.support.webaudio.use)),a.htmlaudio&&"undefined"!=typeof a.htmlaudio.use&&(this.support.htmlaudio.use=a.htmlaudio.use,this.logger.info("options.htmlaudio.use: ",this.support.htmlaudio.use)),a.htmlvideo&&"undefined"!=typeof a.htmlvideo.use&&(this.support.htmlvideo.use=a.htmlvideo.use,this.logger.info("options htmlvideo",this.support.htmlvideo)),this._browserControl(),this.logger.debug(this.support.webaudio.use?"WebAudio use support.":"WebAudio use not support."),this.logger.debug(this.support.htmlaudio.use?"HTMLAudio use support.":"HTMLAudio use not support."),this.logger.debug(this.support.htmlvideo.use?"HTMLVideo use support.":"HTMLVideo use not support."),this.setuped=!0,this)}},{key:"get",value:function(a){return this.pool[a]}},{key:"load",value:function(a,b,c,d){if("function"==typeof arguments[2]&&(d=c,c=null),!this.setuped)return d&&d(new Error("setup incomplete boombox. run: boombox.setup(options)")),this;if(this.pool[a])return this.logger.trace("audio pool cache hit!!",a),d&&d(null,this.pool[a]);var e=this.useMediaType(b.src);if(e&&(b.media=e.media,b.src=e.path),c&&this.isHTMLVideo()){var f=new k.HTMLVideo(a);return e||(f.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof f.state.error||this.runfilter(f,b)?d&&d(new Error(f.state.error),f):(f.load(b,d),this.setPool(a,f,k.HTMLVideo),this)}if(this.isWebAudio()){this.logger.debug("use web audio");var g=new k.WebAudio(a);if(e||(g.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof g.state.error||this.runfilter(g,b))return d&&d(new Error(g.state.error),g);g.load(b,d),this.setPool(a,g,k.WebAudio)}else if(this.isHTMLAudio()){this.logger.debug("use html audio");var h=new k.HTMLAudio(a);if(e||(h.state.error=this.ERROR_MEDIA_TYPE),"undefined"!=typeof h.state.error||this.runfilter(h,b))return d&&d(new Error(h.state.error),h);h.load(b,d),this.setPool(a,h,k.HTMLAudio)}else d&&d(new Error("This environment does not support HTMLAudio, both WebAudio both."),this);return this}},{key:"remove",value:function(a){return this.pool[a]&&(this.logger.trace("Remove Audio that is pooled. name",a),this.pool[a].dispose&&this.pool[a].dispose(),this.pool[a]=void 0,delete this.pool[a]),this}},{key:"setPool",value:function(a,b,c){if(b.isParentSprite()){for(var e in this.pool)~e.indexOf(a+d)&&delete this.pool[e];for(var f in b.sprite.options){var g=a+d+f,h=new c(g,b);this.pool[h.name]=h}}return this.remove(a),this.pool[a]=b,this}},{key:"runfilter",value:function(a,b){for(var c,d=b.filter||[],e=0;e<d.length;e++){var f=d[e],g=this.filter[f];if(!g)return void this.logger.warn("filter not found. name:",f);if(this.logger.debug("filter run. name:",f),g(f,a,b)){c=f;break}}return c?(a.state.error=this.ERROR_HIT_FILTER,this.logger.warn("Hit the filter of",c),!0):!1}},{key:"useMediaType",value:function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._audio.canPlayType(c.media))return c;this.logger.warn("skip audio type.",c.media)}return void 0}},{key:"pause",value:function(){var a=this;this.logger.trace("pause");for(var b in this.pool){var c=this.pool[b];c.pause(),a.waits.push(b)}return this}},{key:"resume",value:function(){this.logger.trace("resume");var a=this.waits.shift();return a&&this.pool[a]&&this.pool[a].resume(),0<this.waits.length&&this.resume(),this}},{key:"power",value:function(a){this.logger.trace("power:",this.name,"flag:",a);for(var b in this.pool){var c=this.pool[b];c.power(a)}return this.state.power=a,this}},{key:"volume",value:function(a){this.logger.trace("volume:",this.name,"volume:",a);for(var b in this.pool){var c=this.pool[b];c.volume(a)}return this}},{key:"onVisibilityChange",value:function(a){this.logger.trace("onVisibilityChange"),document[this.visibility.hidden]?this.pause():this.resume()}},{key:"onFocus",value:function(a){this.logger.trace("onFocus"),this.resume()}},{key:"onBlur",value:function(a){this.logger.trace("onBlur"),this.pause()}},{key:"onPageShow",value:function(a){this.logger.trace("onPageShow"),this.resume()}},{key:"onPageHide",value:function(a){this.logger.trace("onPageHide"),this.pause()}},{key:"_browserControl",value:function(){var a=this;return"undefined"!=typeof document.hidden?(this.visibility.hidden="hidden",this.visibility.visibilityChange="visibilitychange"):"undefined"!=typeof document.webkitHidden?(this.visibility.hidden="webkitHidden",this.visibility.visibilityChange="webkitvisibilitychange"):"undefined"!=typeof document.mozHidden?(this.visibility.hidden="mozHidden",this.visibility.visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden&&(this.visibility.hidden="msHidden",this.visibility.visibilityChange="msvisibilitychange"),this.visibility.hidden&&document.addEventListener(this.visibility.visibilityChange,function(b){a.onVisibilityChange(b)},!1),"undefined"!=typeof window.addEventListener?(window.addEventListener("focus",function(b){a.onFocus(b)},!1),window.addEventListener("blur",function(b){a.onBlur(b)},!1)):(window.attachEvent("onfocusin",function(b){a.onFocus(b)},!1),window.attachEvent("onfocusout",function(b){a.onBlur(b)},!1)),window.onpageshow=function(b){a.onPageShow(b)},window.onpagehide=function(b){a.onPageHide(b)},this}},{key:"addFilter",value:function(a,b){return this.filter[a]=b,this}},{key:"dispose",value:function(){for(var a in this.pool){var b=this.pool[a];b.dispose&&b.dispose()}delete this.VERSION,delete this.setuped,delete this.support.mimes,delete this.support.webaudio.use,this.WEB_AUDIO_CONTEXT&&delete this.WEB_AUDIO_CONTEXT,delete this.support.webaudio,delete this.support.htmlaudio.use,delete this.support.htmlaudio,delete this.support.htmlvideo.use,delete this.support.htmlvideo,delete this.support,delete this.pool,delete this.waits,delete this.visibility,delete this.state.power,delete this.state,delete this._audio,delete this._video,delete this.filter}}]),b}(),k=new j,l=function(){function c(b,d){if(_classCallCheck(this,c),this.logger=new i("HTMLAudio"),this.name=b,this._timer={},this.sprite=void 0,d){var e=f(b),g=d.sprite.options[e.suffix];this.parent=d,this.state=this.parent.state,this.$el=this.parent.$el,this.sprite=new o(void 0,g)}else this.state={time:{playback:void 0,pause:void 0},loop:k.LOOP_NOT,power:k.POWER_ON,loaded:!1,error:void 0},this.$el=new a.Audio}return _createClass(c,[{key:"load",value:function(a,c){var d=c||b;if(this.parent)return d(null,this),this;a=a||{preload:"auto",autoplay:!1,loop:!1,muted:!1,controls:!1};var e=a.timeout||15e3;delete a.timeout,a.spritemap&&(this.sprite=new o(a.spritemap),delete a.spritemap);for(var f in a){var g=a[f];this.logger.trace("HTMLAudioElement attribute:",f,g),this.$el[f]=g}var h=this,i="canplay",j=window.navigator.userAgent.match(/(iPhone\sOS)\s([\d_]+)/);return j&&0<j.length&&(i="suspend"),this.logger.trace("hook event name:",i),this.$el.addEventListener(i,function k(a){return h.logger.trace("processEvent "+a.target.id+" : "+a.type,"event"),h.state.loaded=!0,h.$el.removeEventListener(i,k,!1),d(null,h)}),this.$el.addEventListener("ended",function(a){h._onEnded(a)},!1),setTimeout(function(){h.$el&&4!==h.$el.readyState&&(h.$el.src="",d(new Error("load of html audio file has timed out. timeout:"+e),h),d=function(){})},e),this.$el.load(),this}},{key:"isUse",value:function(){return this.state.power===k.POWER_OFF||k.state.power===k.POWER_OFF?!1:this.state.loaded&&"undefined"==typeof this.state.error?!0:!1}},{key:"isPlayback",value:function(){return!!this.state.time.playback}},{key:"isStop",value:function(){return!this.state.time.playback}},{key:"isPause",value:function(){return!!this.state.time.pause}},{key:"isLoop",value:function(){return 0<this.state.loop}},{key:"isParentSprite",value:function(){return!(this.parent||!this.sprite||this.sprite.current)}},{key:"isSprite",value:function(){return!!(this.parent&&this.sprite&&this.sprite.current)}},{key:"clearTimerAll",value:function(){for(var a in this._timer){{this._timer[a]}this.clearTimer(a)}return this}},{key:"clearTimer",value:function(a){var b=this._timer[a];return b&&(this.logger.debug("remove setTimetout:",b),clearTimeout(b),delete this._timer[a]),b}},{key:"setTimer",value:function(a,b){return this._timer[a]&&this.logger.warn("Access that is not expected:",a,b),this._timer[a]=b,this._timer[a]}},{key:"play",value:function(a){if(!this.isUse())return this.logger.debug("skip play:",this.name,"state can not be used"),this;if(this.isPlayback())return this.logger.debug("skip play:",this.name,"is playing"),this;var c=this,d="play",e=b;if(this.state.time.playback=Date.now(),a&&this.state.time.pause){if(this.setCurrentTime(this.state.time.pause),this.isSprite()){var f=this.state.time.pause;e=function(){var a=Math.ceil(1e3*(c.sprite.current.end-f));c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},a))}}this.state.time.pause=void 0,d="resume:"}else if(this.setCurrentTime(0),this.isSprite()){var g=this.sprite.current.start;this.setCurrentTime(g),e=function(){var a=Math.ceil(1e3*c.sprite.current.term);c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},a))}}return this.logger.debug(d,this.name),e(),this.state.time.name=this.name,this.$el.play(),this}},{key:"stop",value:function(){return this.state.loaded&&"undefined"==typeof this.state.error?this.state.time.name&&this.state.time.name!==this.name?(this.logger.debug("skip stop: It is used in other sources",this.name,this.state.time.name),this):(this.logger.debug("stop:",this.name),this.clearTimer("play"),this.$el.pause(),this.setCurrentTime(0),this.state.time.playback=void 0,this.state.time.name=void 0,this):(this.logger.debug("skip stop:",this.name,"state can not be used"),this)}},{key:"pause",value:function(){return this.isUse()?this.state.time.name&&this.state.time.name!==this.name?(this.logger.debug("skip pause: It is used in other sources",this.name,this.state.time.name),this):(this.logger.debug("pause:",this.name),this.clearTimer("play"),this.$el.pause(),this.state.time.pause=this.$el.currentTime,this.state.time.playback=void 0,this):(this.logger.debug("skip pause:",this.name,"state can not be used"),this)}},{key:"resume",value:function(){return this.isUse()?this.state.time.name&&this.state.time.name!==this.name?(this.logger.debug("skip resume: It is used in other sources",this.name,this.state.time.name),this):(this.state.time.pause&&this.play(!0),this):(this.logger.debug("skip resume:",this.name,"state can not be used"),this)}},{key:"replay",value:function(){return this.isUse()?(this.logger.debug("replay:",this.name),this.clearTimer("play"),this.pause(),this.setCurrentTime(0),this.play(),this):(this.logger.debug("skip replay:",this.name,"state can not be used"),this)}},{key:"volume",value:function(a){this.logger.trace("volume:",this.name,"volume:",a),this.$el.volume=Math.max(0,Math.min(1,a))}},{key:"_onEnded",value:function(a){this.isDisposed()||(this.logger.trace("onended fire! name:",this.name),this.state.time.playback=void 0,this.state.time.name=void 0,this.onEnded(a),this.isDisposed()||this.state.loop===k.LOOP_ORIGINAL&&"undefined"==typeof this.state.time.pause&&(this.logger.trace("onended original loop play.",this.name),this.play()))}},{key:"onEnded",value:function(){b()}},{key:"setLoop",value:function(a){if(!this.isUse())return this;if(this.state.loop=a,a===k.LOOP_NOT)this.$el.loop=k.LOOP_NOT;else if(a===k.LOOP_NATIVE){if(this.isSprite())return this.logger.warn("audiosprite does not support the native. please use the original loop."),this;this.$el&&(this.$el.loop=a)}return this}},{key:"power",value:function(a){return this.logger.trace("power:",this.name,"flag:",a),a===k.POWER_OFF&&this.stop(),this.state.power=a,this}},{key:"setCurrentTime",value:function(a){try{this.$el.currentTime=a}catch(b){this.logger.error("Set currentTime.",b.message)}return this}},{key:"isDisposed",value:function(){return n.prototype.isDisposed.apply(this,arguments)}},{key:"dispose",value:function(){delete this.name,delete this.state.time.playback,delete this.state.time.pause,delete this.state.time.name,delete this.state.time,delete this.state.loop,delete this.state.power,delete this.state.loaded,delete this.state.error,delete this.state,this.$el.src=void 0,delete this.$el,this.clearTimerAll(),delete this._timer,delete this.parent,this.sprite&&this.sprite.dispose&&this.sprite.dispose(),delete this.sprite}}]),c}(),m=function(a){function c(a,b){if(_classCallCheck(this,c),_get(Object.getPrototypeOf(c.prototype),"constructor",this).call(this,a,b),this.logger=new i("HTMLVideo"),this.name=a,this._timer={},this.sprite=void 0,b){var d=f(a),e=b.sprite.options[d.suffix];this.parent=b,this.state=this.parent.state,this.$el=this.parent.$el,this.sprite=new o(void 0,e)}else this.state={time:{playback:void 0,pause:void 0},loop:k.LOOP_NOT,power:k.POWER_ON,loaded:!1,error:void 0},this.$el=document.createElement("video")}return _inherits(c,a),_createClass(c,[{key:"load",value:function(a,c){var d=this,e=c||b;if(this.parent)return e(null,this),this;a=a||{preload:"auto",autoplay:!1,loop:!1,muted:!1,controls:!1};var f=a.timeout||15e3;delete a.timeout,a.spritemap&&(this.sprite=new o(a.spritemap),delete a.spritemap);for(var g in a){var h=a[g];d.logger.trace("HTMLVideoElement attribute:",g,h),d.$el[g]=h}var i="canplay",j=window.navigator.userAgent.match(/(iPhone\sOS)\s([\d_]+)/);return j&&0<j.length?i="suspend":window.navigator.userAgent.match(/(Android)\s+(4)([\d.]+)/)?i="loadeddata":window.navigator.userAgent.match(/(Android)\s+(2)([\d.]+)/)&&(i="stalled"),d.logger.trace("hook event name:",i),this.$el.addEventListener(i,function k(a){return d.logger.trace("processEvent "+a.target.id+" : "+a.type,"event"),d.state.loaded=!0,d.$el.removeEventListener(i,k,!1),e(null,d)}),this.$el.addEventListener("ended",function(a){d._onEnded(a)},!1),setTimeout(function(){d.$el&&4!==d.$el.readyState&&(d.$el.src="",e(new Error("load of html video file has timed out. timeout:"+f),d),e=function(){})},f),this.$el.load(),this}},{key:"isUse",value:function(){_get(Object.getPrototypeOf(c.prototype),"isUse",this).call(this)}},{key:"isPlayback",value:function(){_get(Object.getPrototypeOf(c.prototype),"isPlayback",this).call(this)}},{key:"isStop",value:function(){_get(Object.getPrototypeOf(c.prototype),"isStop",this).call(this)}},{key:"isPause",value:function(){_get(Object.getPrototypeOf(c.prototype),"isPause",this).call(this)}},{key:"isLoop",value:function(){_get(Object.getPrototypeOf(c.prototype),"isLoop",this).call(this)}},{key:"isParentSprite",value:function(){_get(Object.getPrototypeOf(c.prototype),"isParentSprite",this).call(this)}},{key:"isSprite",value:function(){_get(Object.getPrototypeOf(c.prototype),"isSprite",this).call(this)}},{key:"clearTimerAll",value:function(){_get(Object.getPrototypeOf(c.prototype),"clearTimerAll",this).call(this)}},{key:"clearTimer",value:function(a){_get(Object.getPrototypeOf(c.prototype),"clearTimer",this).call(this,a)}},{key:"setTimer",value:function(a,b){_get(Object.getPrototypeOf(c.prototype),"setTimer",this).call(this,a,b)}},{key:"play",value:function(a){if(!this.isUse())return this.logger.debug("skip play:",this.name,"state can not be used"),this;if(this.isPlayback())return this.logger.debug("skip play:",this.name,"is playing"),this;var c=this,d="play",e=b;if(this.state.time.playback=Date.now(),a&&this.state.time.pause){if(this.setCurrentTime(this.state.time.pause),this.isSprite()){var f=this.state.time.pause;e=function(){var a=Math.ceil(1e3*(c.sprite.current.end-f));c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},a))}}this.state.time.pause=void 0,d="resume:"}else if(this.setCurrentTime(0),this.isSprite()){var g=this.sprite.current.start;this.setCurrentTime(g),e=function(){var a=Math.ceil(1e3*c.sprite.current.term);c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},a))}}return this.logger.debug(d,this.name),e(),this.state.time.name=this.name,this.$el.play(),this}},{key:"stop",value:function(){_get(Object.getPrototypeOf(c.prototype),"stop",this).call(this)}},{key:"pause",value:function(){_get(Object.getPrototypeOf(c.prototype),"pause",this).call(this)}},{key:"resume",value:function(){_get(Object.getPrototypeOf(c.prototype),"resume",this).call(this)}},{key:"replay",value:function(){_get(Object.getPrototypeOf(c.prototype),"replay",this).call(this)}},{key:"volume",value:function(a){_get(Object.getPrototypeOf(c.prototype),"volume",this).call(this,a)}},{key:"_onEnded",value:function(a){_get(Object.getPrototypeOf(c.prototype),"_onEnded",this).call(this,a)}},{key:"onEnded",value:function(){b()}},{key:"setLoop",value:function(a){_get(Object.getPrototypeOf(c.prototype),"setLoop",this).call(this,a)}},{key:"power",value:function(a){_get(Object.getPrototypeOf(c.prototype),"power",this).call(this,a)}},{key:"setCurrentTime",value:function(a){_get(Object.getPrototypeOf(c.prototype),"setCurrentTime",this).call(this,a)}},{key:"isDisposed",value:function(){_get(Object.getPrototypeOf(c.prototype),"isDisposed",this).call(this)}},{key:"dispose",value:function(){_get(Object.getPrototypeOf(c.prototype),"dispose",this).call(this)}}]),c}(l),n=function(a){function c(a,b){if(_classCallCheck(this,c),_get(Object.getPrototypeOf(c.prototype),"constructor",this).call(this,a,b),this.logger=new i("WebAudio"),this.name=a,this._timer={},this.sprite=void 0,this.buffer=void 0,this.source=void 0,this.ctx=k.WEB_AUDIO_CONTEXT,this.gainNode=this.ctx.createGain(),this.state={time:{playback:void 0,pause:void 0,progress:0},loop:k.LOOP_NOT,power:k.POWER_ON,loaded:!1,error:void 0},b){var d=f(a);this.parent=b,this.state.loaded=this.parent.state.loaded,this.state.error=this.parent.state.error;var e=b.sprite.options[d.suffix];this.sprite=new o(void 0,e)}}return _inherits(c,a),_createClass(c,[{key:"load",value:function(a,c){var e=this;a=a||{};var f=c||b;if(this.parent)return f(null,this),this;a.spritemap&&(this.sprite=new o(a.spritemap),delete a.spritemap);for(var g in a){var h=a[g];this.logger.trace("WebAudio attribute:",g,h)}var i=new XMLHttpRequest;i.onload=function(b){return"2"!==b.target.status.toString().charAt(0)?(e.logger.error("fail to load resource: ",a.url),f(new Error("fail to load resource"),e)):void e.ctx.decodeAudioData(i.response,function(b){if(!b)return e.logger.error("error decode file data: ",a.url),f(new Error("error decode file data"),e);if(e.buffer=b,e.state.loaded=!0,e.isParentSprite())for(var c in k.pool)~c.indexOf(e.name+d)&&(k.pool[c].buffer=b,k.pool[c].state.loaded=e.state.loaded);return f(null,e)},function(){return f(new Error("fail to decode file data"),e)})};var j=a.timeout||15e3;return setTimeout(function(){4!==i.readyState&&(i.abort(),f(new Error("load of web audio file has timed out. timeout:"+j),e),f=b)},j),i.open("GET",a.src,!0),i.responseType="arraybuffer",i.send(),this}},{key:"isUse",value:function(){_get(Object.getPrototypeOf(c.prototype),"isUse",this).call(this)}},{key:"isPlayback",value:function(){return!(!this.source||!this.state.time.playback||this.state.time.pause||1!==this.source.playbackState&&2!==this.source.playbackState)}},{key:"isStop",value:function(){return!this.source}},{key:"isPause",value:function(){_get(Object.getPrototypeOf(c.prototype),"isPause",this).call(this)}},{key:"isLoop",value:function(){_get(Object.getPrototypeOf(c.prototype),"isLoop",this).call(this)}},{key:"isParentSprite",value:function(){_get(Object.getPrototypeOf(c.prototype),"isParentSprite",this).call(this)}},{key:"isSprite",value:function(){_get(Object.getPrototypeOf(c.prototype),"isSprite",this).call(this)}},{key:"clearTimerAll",value:function(){_get(Object.getPrototypeOf(c.prototype),"clearTimerAll",this).call(this)}},{key:"clearTimer",value:function(a){_get(Object.getPrototypeOf(c.prototype),"clearTimer",this).call(this,a)}},{key:"setTimer",value:function(a,b){_get(Object.getPrototypeOf(c.prototype),"setTimer",this).call(this,a,b)}},{key:"play",value:function(a){var c=this;if(!this.isUse())return this.logger.debug("skip play:",this.name,"state can not be used"),this;if(this.isPlayback())return this.logger.debug("skip play:",this.name,"is playing"),this;a||this.sourceDispose(),this.source=this.ctx.createBufferSource(),this.state.loop===k.LOOP_NATIVE&&(this.source.loop=this.state.loop),this.source.buffer=this.buffer,this.source.connect(this.gainNode),this.gainNode.connect(this.ctx.destination);var d="play",e=b,f=0;if(this.state.time.playback=Date.now(),a&&this.state.time.pause){if(f=this.state.time.pause/1e3,this.isSprite()){var g=this.state.time.pause/1e3;f=this.sprite.current.start+g;var h=Math.ceil(1e3*(c.sprite.current.term-g));e=function(){c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},h))}}this.state.time.pause=void 0}else this.isSprite()&&(f=this.sprite.current.start,e=function(){var a=Math.ceil(1e3*c.sprite.current.term);c.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},a))});this.logger.debug(d,this.name,"offset:",f),e();var i=this.buffer.duration-f;if(!this.isSprite())if(this.source.hasOwnProperty("onended"))this.source.onended=function(a){c._onEnded(a)};else{var h=Math.ceil(1e3*i);this.setTimer("play",setTimeout(function(){c.stop(),c._onEnded()},h))}return this.source.start?(this.logger.debug("use source.start()",this.name,f,i),this.source.start(0,f,this.buffer.duration)):(this.isSprite()&&(i=c.sprite.current.term),this.logger.debug("use source.noteGrainOn()",this.name,f,i),this.source.noteGrainOn(0,f,i)),this}},{key:"stop",value:function(){return this.state.loaded&&"undefined"==typeof this.state.error?(this.logger.debug("stop:",this.name),this.clearTimer("play"),this.source&&(this.source.stop?(this.logger.debug("stop: use source.stop()",this.name),this.source.stop(0)):(this.logger.debug("stop: use source.noteOff()",this.name),this.source.noteOff(0))),this.sourceDispose(),this):(this.logger.debug("skip stop:",this.name,"state can not be used"),this)}},{key:"pause",value:function(){if(!this.isUse())return this.logger.debug("skip pause:",this.name,"state can not be used"),this;if(!this.source)return this.logger.debug("skip pause, Not playing."),this;if(this.state.time.pause)return this.logger.debug("skip pause, It is already paused."),this;var a=Date.now(),b=a-this.state.time.playback;return this.state.time.pause=this.state.time.progress+b,this.state.time.progress+=b,this.logger.trace("state.time.pause:",this.state.time.pause,"now:",a,"state.time.playback",this.state.time.playback),this.logger.debug("pause:",this.name),this.clearTimer("play"),this.source&&(this.source.stop?(this.logger.debug("pause: use source.stop()",this.name),this.source.stop(0)):(this.logger.debug("pause: use source.noteOff()",this.name),this.source.noteOff(0))),this}},{key:"resume",value:function(){return this.isUse()?(this.state.time.pause&&this.play(!0),this):(this.logger.debug("skip resume:",this.name,"state can not be used"),this)}},{key:"replay",value:function(){return this.isUse()?(this.logger.debug("replay:",this.name),this.clearTimer("play"),this.sourceDispose(),this.play(),this):(this.logger.debug("skip replay:",this.name,"state can not be used"),this)}},{key:"volume",value:function(a){this.logger.trace("volume:",this.name,"volume:",a),this.gainNode.gain.value=a}},{key:"_onEnded",value:function(a){if(!this.isDisposed()){var b=this,c=Date.now();if(b.source&&Math.abs((c-b.state.time.playback+b.state.time.progress)/1e3-b.source.buffer.duration)>=k.THRESHOLD)return void b.logger.debug("skip if sounds is not ended",b.name);this.logger.trace("onended fire!",this.name),this.state.time.playback=void 0,this.onEnded(a),this.isDisposed()||(this.state.loop&&"undefined"==typeof this.state.time.pause?(this.logger.trace("onended loop play."),this.play()):this.sourceDispose())}}},{key:"onEnded",value:function(){b()}},{key:"setLoop",value:function(a){return this.isUse()?(this.state.loop=a,a===k.LOOP_NOT?this.source&&(this.source.loop=k.LOOP_NOT):a===k.LOOP_NATIVE&&this.source&&(this.source.loop=a),this):this}},{key:"power",value:function(a){_get(Object.getPrototypeOf(c.prototype),"power",this).call(this,a)}},{key:"sourceDispose",value:function(){this.logger.trace("source dispose",this.name),this.source&&this.source.disconnect(),this.source=void 0,this.state.time.playback=void 0,this.state.time.pause=void 0,this.state.time.progress=0}},{key:"isDisposed",value:function(){return this.logger.trace("check dispose flag",!!this.state),!this.state}},{key:"dispose",value:function(){this.logger.trace("WebAudio dispose",this.name),delete this.buffer,this.sourceDispose(),delete this.source,this.clearTimerAll(),delete this._timer,delete this.state.time,delete this.state.loop,delete this.state.power,delete this.state.loaded,delete this.state.error,delete this.state,this.parent=null,delete this.parent,this.sprite&&this.sprite.dispose&&this.sprite.dispose(),delete this.sprite,delete this.name,this.gainNode&&this.gainNode.disconnect&&delete this.gainNode,this.ctx=null}}]),c}(l),o=function(){function a(b,c){if(_classCallCheck(this,a),this.logger=new i("Sprite   "),this.current=c,this.options=b,!c)for(var d in this.options)this.options[d].term=this.options[d].end-this.options[d].start}return _createClass(a,[{key:"dispose",value:function(){this.options=null,delete this.options,delete this.current}}]),a}();k.HTMLAudio=l,k.HTMLVideo=m,k.WebAudio=n,c?define([],function(){return k}):a.boombox=k}(window);
//# sourceMappingURL=boombox.min.map